<!doctype html>
<html lang="de">
	<head>
		<link rel="apple-touch-icon" href="style/images/aster.ico">
		<link rel="icon" href="style/images/aster.ico">
		<meta charset="utf-8">
		<script src="vendor/couchapp/jquery.js"></script>
		<script src="vendor/couchapp/bootstrap.js"></script>
		<script src="vendor/couchapp/jquery.jstree.js"></script>
		<script src="vendor/couchapp/jquery.cookie.js"></script>
		<script src="vendor/couchapp/jquery.hotkeys.js"></script>
		<script src="vendor/couchapp/jquery.couch.js"></script>
		<script src="vendor/couchapp/jquery.csv.js"></script>
		<script src="vendor/couchapp/jsuri.js"></script>
		<script src="vendor/couchapp/FileSaver.js"></script>
		<script src="vendor/couchapp/artendb.js"></script>
		<link rel="stylesheet" href="style/bootstrap.css">
		<link rel="stylesheet" href="style/artendb.css">
		<script src="vendor/couchapp/modernizr.js"></script>
		<title>ArtenDb</title>
	</head>
	<body>
		<div id="menu_btn" class="btn-group">
			<a class="btn dropdown-toggle btn-inverse" data-toggle="dropdown" href="#">
				Menu
				<span class="caret"></span>
			</a>
			<ul class="dropdown-menu">
				<li class="dropdown-submenu">
					<a tabindex="-1" href="#">Daten importieren / löschen</a>
					<ul class="dropdown-menu">
						<li><a id="eigenschaften_importieren" href="#">Eigenschaften</a></li>
						<li class="disabled"><a id="beziehungen_importieren" href="#">Beziehungen</a></li>
					</ul>
				</li>
				<li><a id="exportieren" href="#">Daten exportieren</a></li>
				<li class="dropdown-submenu">
					<a tabindex="-1" href="#">über diese Anwendung</a>
					<ul class="dropdown-menu">
						<li><a href="https://github.com/barbalex/artendb/blob/master/README.md" target="_blank">Projektbeschreibung</a></li>
						<li><a href="https://github.com/barbalex/artendb" target="_blank">Code</a></li>
						<li><a href="https://github.com/barbalex/artendb/commits/master" target="_blank">Letzte Änderungen</a></li>
						<li><a href="mailto:alex.barbalex@gmail.com">Kontakt</a></li>
					</ul>
				</li>
				<li id="GoogleBilderLink_li" class="disabled"><a id="GoogleBilderLink" href="" target="_blank">Bilder suchen</a></li>
				<li id="WikipediaLink_li" class="disabled"><a id="WikipediaLink" href="" target="_blank">in Wikipedia suchen</a></li>
			</ul>
		</div>
		<fieldset id="menu">
			<div>
				<div id="menu-div">
					<div id="Gruppe_label">Gruppe wählen:</div>
				</div>
				<div id="Gruppe" class="btn-group" data-toggle="buttons-radio">
					<button class="btn btn-inverse" name="Gruppe" id="GruppeFauna" value="Fauna" treeBeschriftung="Tiere">Fauna</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeFlora" value="Flora" treeBeschriftung="Pflanzen">Flora</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeMoose" value="Moose" treeBeschriftung="Moose">Moose</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeMacromycetes" value="Macromycetes" treeBeschriftung="Pilze">Pilze</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeLebensräume" value="Lebensräume" treeBeschriftung="Lebensräume">Lebensräume</button>
				</div>
			</div>
			<div id="suchen" class="input-prepend">
				<span class="add-on"><i id="suchfeld_icon" class="icon-search"></i></span><input id="suchfeld" class="span2" type="search" placeholder="filtern">
				<button id="suche_leeren_btn" class="close">&times;</button>
			</div>
			<div id="treeFaunaBeschriftung" class="treeBeschriftung"></div>
			<div id="treeFloraBeschriftung" class="treeBeschriftung"></div>
			<div id="treeMooseBeschriftung" class="treeBeschriftung"></div>
			<div id="treeMacromycetesBeschriftung" class="treeBeschriftung"></div>
			<div id="treeLebensräumeBeschriftung" class="treeBeschriftung"></div>
			<div id="treeFauna" class="baum"></div>
			<div id="treeFlora" class="baum"></div>
			<div id="treeMoose" class="baum"></div>
			<div id="treeMacromycetes" class="baum"></div>
			<div id="treeLebensräume" class="baum"></div>
		</fieldset>

		<fieldset id="forms">

			<form id="art" class="form form-horizontal" action="#" method="get" autocomplete="off"></form>
			
			<form id="import" class="form form-horizontal" action="#" method="get" autocomplete="off">
				<div id="importieren_accordion" class="accordion">
					<div id="importieren_anmelden" class="accordion-group">
						<div class="accordion-heading accordion-group_gradient">
							<a id="importieren_anmelden_titel" class="accordion-toggle" data-toggle="collapse" data-parent="importieren_accordion" href="#importieren_anmelden_collapse">1. Anmelden</a>
						</div>
						<div id="importieren_anmelden_collapse" class="accordion-body collapse">
							<div class="accordion-inner">
								<div class="control-group">
									<label class="control-label" for="Email">Email</label>
									<div class="controls">
										<input type="email" id="Email" placeholder="Email" required>
										<div id="Emailhinweis" class="hinweis text-error">Bitte Email erfassen</div>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="Passwort">Passwort</label>
									<div class="controls">
										<input type="password" id="Passwort" placeholder="Passwort" required>
										<div id="Passworthinweis" class="hinweis text-error">Bitte Passwort erfassen</div>
										<div class="signup">Vorsicht: Email und Passwort können später nicht mehr geändert werden!</div>
										<div class="signup">Es wird eine verschlüsselte Version des Passworts gespeichert. Das Original kennt ausser Ihnen niemand.</div>
									</div>
								</div>
								<div class="control-group signup">
									<label class="control-label" for="Passwort2">Passwort bestätigen</label>
									<div class="controls">
										<input type="password" id="Passwort2" placeholder="Passwort bestätigen" required>
										<div id="Passwort2hinweis" class="hinweis text-error">Bitte Passwort bestätigen</div>
										<div id="Passwort2hinweisFalsch" class="hinweis text-error">Die Passwörter stimmen nicht überein</div>
									</div>
								</div>
								<div class="feld">
									<button id="anmelden_btn" class="btn">anmelden</button>
									<button id="abmelden_btn" class="btn" style="display:none;">abmelden</button>
									<button id="konto_erstellen_btn" class="btn">neues Konto erstellen</button>
									<button id="konto_speichern_btn" class="btn" style="display:none;">neues Konto speichern</button>
								</div>
								<div id="importieren_anmelden_fehler" class="alert alert-error">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_anmelden_fehler_text"></div>
								</div>
								<div id="importieren_anmelden_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_anmelden_hinweis_text"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_ds_beschreiben">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" data-parent="importieren_accordion" href="#importieren_ds_beschreiben_collapse">
								2. Datensammlung beschreiben
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_ds_beschreiben_collapse">
							<div class="accordion-inner">
								<div class="control-group">
									<label class="control-label" for="DsWaehlen">Bestehende wählen</label>
									<select type="text" class="controls" id="DsWaehlen"></select>
								</div>
								<div class="feld">
									<button type="button" class="btn" id="DsLoeschen" style="display:none; margin-bottom:6px;">Gewählte Datensammlung und alle ihre Eigenschaften aus allen Arten und/oder Lebensräumen entfernen</button>
									<div id="importieren_ds_beschreiben_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_ds_beschreiben_hinweis_text"></div>
								</div>
								</div>
								<hr>
								<div class="control-group">
									<label class="control-label" for="DsName">Name</label>
									<input type="text" class="controls" id="DsName">
								</div>
								<div class="control-group">
									<label class="control-label" for="DsBeschreibung">Beschreibung</label>
									<textarea class="controls" id="DsBeschreibung"></textarea>
								</div>
								<div class="control-group">
									<label class="control-label" for="DsDatenstand">Datenstand</label>
									<textarea class="controls" id="DsDatenstand"></textarea>
								</div>
								<div class="control-group">
									<label class="control-label" for="DsLink">Link</label>
									<textarea class="controls" id="DsLink"></textarea>
								</div>
								<div class="control-group">
									<label class="control-label" for="DsAnzDs" id="DsAnzDs_label"></label>
									<div id="DsAnzDs" class="feldtext controls"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_daten_uploaden">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" data-parent="importieren_accordion" href="#importieren_daten_uploaden_collapse">
								3. Eigenschaften laden
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_daten_uploaden_collapse">
							<div class="accordion-inner">
								<div class="form-actions">
									<div class="fileupload fileupload-new" data-provides="fileupload">
										<div class="input-append">
											<div class="uneditable-input span3"><i class="icon-file fileupload-exists"></i> <span class="fileupload-preview"></span></div><span class="btn btn-file"><span class="fileupload-new">Datei wählen</span><span class="fileupload-exists">neue Datei wählen</span><input type="file" id="DsFile" /></span><a href="#" class="btn fileupload-exists" data-dismiss="fileupload">Datei entfernen</a>
										</div>
									</div>
								</div>
								<div id="DsTabelleEigenschaften" class="tabelle">
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_ids_identifizieren">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" data-parent="importieren_accordion" href="#importieren_ids_identifizieren_collapse">
								4. ID's identifizieren
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_ids_identifizieren_collapse">
							<div class="accordion-inner">
								<div id="DsFelder_div" class="control-group"></div>
								<div class="control-group">
									<label class="control-label" for="DsId">zugehörige ID in ArtenDb</label>
									<select type="text" class="controls" id="DsId"  multiple="multiple" style="height:95px;">
										<option value="guid">GUID der ArtenDb</option>
										<option value="Fauna">ID der Info Fauna (NUESP)</option>
										<option value="Flora">ID der Info Flora (SISF-NR)</option>
										<option value="Moose">ID des Datenzentrums Moose Schweiz (TAXONNO)</option>
										<option value="Macromycetes">ID von Swissfungi (TaxonId)</option>
									</select>
								</div>
								<div id="importieren_ids_identifizieren_fehler" class="alert alert-error">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_ids_identifizieren_fehler_text"></div>
								</div>
								<div id="importieren_ids_identifizieren_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_ids_identifizieren_hinweis_text"></div>
								</div>
								<div id="importieren_ids_identifizieren_erfolg" class="alert alert-success">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_ids_identifizieren_erfolg_text"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_import_ausfuehren">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" data-parent="importieren_accordion" href="#importieren_import_ausfuehren_collapse">
								5. Import ausführen
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_import_ausfuehren_collapse">
							<div class="accordion-inner">
								<button type="button" class="btn" id="DsImportieren" style="margin-bottom:6px;">Datensammlung mit allen Eigenschaften importieren</button>
								<button type="button" class="btn disabled" id="DsEntfernen" style="margin-bottom:6px;">Datensammlung mit allen Eigenschaften aus den in der geladenen Datei enthaltenen Arten/Lebensräumen entfernen</button>
								<div id="importieren_import_ausfuehren_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_import_ausfuehren_hinweis_text"></div>
								</div>
							</div>
						</div>
					</div>
				</div>		
			</form>

			<form id="export" class="form form-horizontal" action="#" method="get" autocomplete="off">
				<div class="accordion" id="exportieren_accordion">
					<div class="accordion-group" id="exportieren_objekte_waehlen_gruppen">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_objekte_waehlen_gruppen_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_objekte_waehlen_gruppen_collapse" data-parent="exportieren_accordion" href="#exportieren_objekte_waehlen_gruppen_collapse">1. Gruppe(n) wählen</a>
						</div>
						<div class="accordion-body collapse in" id="exportieren_objekte_waehlen_gruppen_collapse">
							<div class="accordion-inner">
								<div class="well well-small">So geht's:
									<ul>
										<li>Wählen Sie eine oder mehrere Gruppen</li>
										<li>Danach werden die Eigenschaften der Gruppe aufgebaut.<br>Sie können anschliessend innerhalb der Gruppe(n) filtern</li>
										<li>Eine Gruppe kann auch wieder entfernt werden</li>
										<li>Mit der Schaltfläche "Alle Taxonomien zusammenfassen" werden alle in den gewählten Gruppen vorkommenden Taxonomien unter dem Titel "Taxonomie(n)" zusammegefasst und alle vorkommenden Felder aufgelistet. Das ist vor allem für Lebensräume interessant: Jeder Lebensraumschlüssel stellt eine Taxonomie dar und oft haben sie dieselben Felder. Filtern Sie beispielsweise im Feld "Taxonomie" nach "Delarze", können Sie alle Informationen von Delarze gleichzeitig exportieren</li>
									</ul>
								</div>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" view="fauna" value="Fauna">Fauna
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" view="flora" value="Flora">Flora
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" view="moose" value="Moose">Moose
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" view="macromycetes" value="Macromycetes">Pilze
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" view="lr" value="Lebensräume">Lebensräume
								</label>
								<button id="exportieren_objekte_Taxonomien_zusammenfassen" type="button" class="btn" data-toggle="button" style="margin-bottom:9px;">Alle Taxonomien zusammenfassen</button>
								<div id="exportieren_objekte_waehlen_gruppen_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="exportieren_objekte_waehlen_gruppen_hinweis_text"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="exportieren_objekte_waehlen_eigenschaften">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_objekte_waehlen_eigenschaften_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_objekte_waehlen_eigenschaften_collapse" data-parent="exportieren_accordion" href="#exportieren_objekte_waehlen_eigenschaften_collapse">2. Nach Eigenschaften filtern</a>
						</div>
						<div class="accordion-body collapse" id="exportieren_objekte_waehlen_eigenschaften_collapse">
							<div class="accordion-inner">
								<div class="well well-small" style="margin-bottom:0px;">So geht's:
									<ul>
										<li>Nachfolgend sind alle Felder aufgelistet, die in den gewählten Gruppen vorkommen</li>
										<li>Sie filtern, indem sie im Feld ihrer Wahl das gewünschte Kriterium erfassen...</li>
										<li>...und danach zuunterst bei "4. Exportieren" die Vorschau anzeigen.
											<br>Dazu müssen Sie an allen Feldern vorbei ganz nach unten scrollen</li>
										<li>Unterhalb von "Vorschau anzeigen" wird Ihnen danach die Anzahl "Treffer" angezeigt</li>
										<li>Sie können nach beliebig vielen Feldern filtern. Jedes Kriterium reduziert die Anzahl "Treffer".<br>Beispiel: Filtern Sie im Namen nach "Eisvogel" und in der Ordnung nach "Lepidoptera", erhalten Sie drei Schmetterlinge aber nicht den entsprechenden Vogel</li>
										<li>Sie möchten nach "Schmetterlinge" oder "Vögel" suchen? Dann exportieren Sie zuerst "Schmetterlinge", danach die "Vögel" und setzen die zwei Exporte einfach zusammen</li>
										<li>Es kommt nicht auf Gross-/Kleinschreibung an.
											<br>Beispiel: Schreiben Sie "eisvogel", wird auch "Eisvogel" gefunden</li>
										<li>Sie können nach einem Teil des Feldinhalts filtern.
											<br>Beispiel: Schreiben Sie "Vogel", wird auch "Eisvogel" gefunden</li>
										<li>Sie möchten nach einem Feld filtern, das entweder ja oder nein, wahr oder falsch ist? Verwenden Sie die Englischen Begriffe "true" und "false" (ohne Hochzeichen)</li>
									</ul>
								</div>
								<div class="control-group">
									<h5>Art / Lebensraum</h5>
								</div>
								<div class="control-group">
									<label class="control-label" for="exportieren_objekte_waehlen_eigenschaften_guid">GUID</label>
									<div class="controls">
										<input class="export_feld_filtern" type="text" id="exportieren_objekte_waehlen_eigenschaften_guid" Eigenschaft="keine" Feld="_id">
									</div>
								</div>
								<div id="exportieren_objekte_waehlen_eigenschaften_felderliste"></div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="exportieren_felder_waehlen">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_felder_waehlen_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_felder_waehlen_collapse" data-parent="exportieren_accordion" href="#exportieren_felder_waehlen_collapse">3. Eigenschaften wählen</a>
						</div>
						<div class="accordion-body collapse" id="exportieren_felder_waehlen_collapse">
							<div class="accordion-inner">
								<div class="well well-small" style="margin-bottom:0px;">So geht's:
									<ul>
										<li>Nachfolgend sind alle Felder aufgelistet, die in den gewählten Gruppen vorkommen</li>
										<li>Markieren Sie die Felder, die Sie exportieren möchten...</li>
										<li>...und fahren Sie danach mit "4. Exportieren" weiter
											<br>Bei Gruppen mit sehr vielen Eigenschaften müssen Sie dazu an allen Feldern vorbei ganz nach unten scrollen</li>
										<li>Felder werden auch dann exportiert, wenn sie keine Daten enthalten</li>
										<li>Einzelne Felder, wie z.B. Verweise auf andere Arten/Lebensräume, enthalten JSON-Objekte. Das sind komplexe Datenstrukturen, die nicht in ein einfaches Datenfeld passen. Sie werden darum einfach im JSON-Format in das ensprechende Tabellenfeld exportiert. Erkenntlich sind sie u.a. an den {geschweiften Klammern}</li>
									</ul>
								</div>
								<h5>Art / Lebensraum</h5>
								<div class="felderspalte">
									<label class="checkbox">
										<input id="exportieren_felder_waehlen_objekt_id" class="exportieren_felder_waehlen_objekt_feld feld_waehlen" type="checkbox" feldname="GUID" value="_id">GUID
									</label>
									<label class="checkbox">
										<input id="exportieren_felder_waehlen_objekt_gruppe" class="exportieren_felder_waehlen_objekt_feld feld_waehlen" type="checkbox" feldname="Gruppe" value="Gruppe">Gruppe
									</label>
								</div>
								<div id="exportieren_felder_waehlen_felderliste"></div>
							</div>
						</div>
					</div>

					<div id="exportieren_exportieren" class="accordion-group">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_exportieren_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_exportieren_collapse" data-parent="exportieren_accordion" href="#exportieren_exportieren_collapse">4. Exportieren</a>
						</div>
						<div id="exportieren_exportieren_collapse" class="accordion-body collapse">
							<div class="accordion-inner">
								<div class="well well-small" style="margin-bottom:9px;">So geht's:
									<ul>
										<li>Klicken Sie auf "Vorschau anzeigen"...</li>
										<li>... danach wird eine Vorschau der ersten 10 Datensätze angezeigt</li>
										<li>... und es erscheint die Schaltfläche "herunterladen"</li>
										<li>... das kann eine ganze Weile dauern!</li>
										<li>Der Download hat das .csv-Format:
											<ul>
												<li>Zeichensatz ist UTF-8 (wichtig, sonst werden Umlaute zu Datensalat)</li>
												<li>Die erste Zeile enthält die Feldnamen</li>
												<li>Felder sind mit Kommas (,) getrennt</li>
												<li>Text ist in Anführungs- und Schlusszeichen (") eingeschlossen</li>
											</ul>
										</li>
									</ul>
								</div>
								<button id="exportieren_exportieren_tabelle_aufbauen" class="btn">Vorschau anzeigen</button>
								<button id="exportieren_exportieren_exportieren" class="btn" style="display:none;">herunterladen</button>
								<div id="exportieren_exportieren_tabelle" class="tabelle" style="padding-top:7px;margin-bottom:7px;"></div>
								<div id="exportieren_exportieren_hinweis" class="alert alert-info" style="margin-top:7px;">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="exportieren_exportieren_hinweis_text"></div>
								</div>
							</div>
						</div>
					</div>

				</div>		
			</form>

		</fieldset>

		<script>
			$(document).ready(function () {
				$("#forms").hide();
				//prüfen, ob media queries unterstützt werden. Wenn nein, melden und Einsteigen verhindern
				if (!Modernizr.mq('(min-width: 10px)')) {
					$('#meldung_kompatibilität').modal();
					return;
				}

				//prüfen, ob history unterstützt wird. Wenn nein, melden und Einsteigen verhindern
				if (!Modernizr.history) {
					$('#meldung_kompatibilität').modal();
					return;
				}

				$("#suchen").hide();

				//falls URL übergeben wurde, das entsprechende Dokument öffnen
				//soll auch ausgelöst werden, wenn die Rücktaste oder Vortaste getätigt wird
				window.addEventListener('popstate', function(event) {
					oeffneUri();
				});

				//wenn User noch angemeldet ist, UI anpassen
				if (localStorage.Email) {
					$("#importieren_anmelden_titel").text("1. " + localStorage.Email + " ist angemeldet");
					$("#anmelden_btn").hide();
					$("#abmelden_btn").show();
					$("#konto_erstellen_btn").hide();
					$("#konto_speichern_btn").hide();
				}

				//Baum aufbauen, wenn Gruppe gewählt wird
				$("#menu").on("click", "[name='Gruppe']", function () {
					//Gruppe als globale Variable speichern, weil sie an vielen Orten benutzt wird
					window.Gruppe = this.value;
					$("#suchfeld").val("");
					$("#Gruppe_label").html("Gruppe:");
					$("#suchen").hide();
					$("#forms").hide();
					$("#suchen").val("");
					erstelleBaum();
				});

				//Menu: Links zu Google Bilder und Wikipedia nur aktiv setzen, wenn Art oder Lebensraum angezeigt wird
				$("body").on("click", "#menu_btn", function() {
					if ($("#art").html().length > 0) {
						$("#GoogleBilderLink_li").removeClass("disabled");
						$("#WikipediaLink_li").removeClass("disabled");
					} else {
						$("#GoogleBilderLink_li").addClass("disabled");
						$("#WikipediaLink_li").addClass("disabled");
					}
				});

				$("#menu_btn").on("click", "#eigenschaften_importieren", function() {
					//testen, ob der Browser das Importieren unterstützt
					//wenn nein, Meldung bringen (macht die aufgerufene Funktion)
					if(isFileAPIAvailable()) {
						zeigeFormular("import");
						//Ist der User noch angemeldet? Wenn ja: Anmeldung überspringen
						if (localStorage.Email) {
							$("#importieren_ds_beschreiben_collapse").collapse('show');
						} else {
							$("#importieren_anmelden_collapse").collapse('show');
						}
					}
				});

				$('#importieren_ds_beschreiben_collapse').on('shown', function() {
					bereiteImportieren_ds_beschreibenVor();
				});

				$('#importieren_daten_uploaden_collapse').on('shown', function (event) {
					if (!localStorage.Email) {
						$(this).collapse('hide');
						zurueckZurAnmeldung();
					} else {
						$('#DsFile').fileupload();
					}
				});

				$('#importieren_ids_identifizieren_collapse').on('shown', function (event) {
					if (!localStorage.Email) {
						$(this).collapse('hide');
						zurueckZurAnmeldung();
					}
				});

				$('#importieren_import_ausfuehren_collapse').on('shown', function (event) {
					if (!localStorage.Email) {
						$(this).collapse('hide');
						zurueckZurAnmeldung();
					}
				});

				$("#import").on("change", "#DsWaehlen", function() {
					var that = this;
					//zuerst alle Felder leeren
					$('#import textarea, #import input').each(function () {
						$(this).val('');
						$("#DsAnzDs").html("");
						$("#DsAnzDs_label").html("");
					});
					if (that.value) {
						for (i in window.ds_von_objekten.rows) {
							if (window.ds_von_objekten.rows[i].key[0] === that.value) {
								$("#DsName").val(that.value);
								for (x in window.ds_von_objekten.rows[i].key[1]) {
									$("#Ds" + x).val(window.ds_von_objekten.rows[i].key[1][x]);
								}
								$("#DsAnzDs").html(window.ds_von_objekten.rows[i].value);
								$("#DsAnzDs_label").html("Anzahl Datensätze");
								//dafür sorgen, dass textareas genug gross sind
								$('#import textarea').each(function () {
									$(this).trigger('focus');
								});
								$("#DsName").focus();
							}
							//löschen-Schaltfläche einblenden
							$("#DsLoeschen").css("display", "block");
						}
					} else {
						//löschen-Schaltfläche ausblenden
						$("#DsLoeschen").css("display", "none");
					}
				});

				$("#import").on("change", "#DsFile", function(e) {
					e.preventDefault();
					// Check for the various File API support
					if (window.File && window.FileReader && window.FileList && window.Blob) {
						// Great success! All the File APIs are supported
					} else {
						alert('Ihr Browser unterstützt diesen Vorgang leider nicht');
						return;
					}
					var file = e.target.files[0],
					reader = new FileReader();
					reader.onload = function (event) {
						window.Datensätze = $.csv.toObjects(event.target.result);
						erstelleTabelle(window.Datensätze, "DsTabelleEigenschaften");
					};
					reader.readAsText(file);
				});

				$("#import").on("change", "#DsFelder", function(e) {
					meldeErfolgVonIdIdentifikation();
				});

				$("#import").on("change", "#DsId", function(e) {
					meldeErfolgVonIdIdentifikation();
				});

				$("#import").on("click", "#DsLoeschen", function(e) {
					e.preventDefault();
					//Rückmeldung anzeigen
					$("#importieren_ds_beschreiben_hinweis").alert().css("display", "block");
					$("#importieren_ds_beschreiben_hinweis_text").html("Bitte warten: Die Datensammlung wird entfernt...");
					$.when(entferneDatensammlungAusAllenObjekten($("#DsName").val())).then(function() {
						//jetzt Ergebnisse anzeigen
						$("#importieren_ds_beschreiben_hinweis").alert().css("display", "block");
						$("#importieren_ds_beschreiben_hinweis_text").html("Die Datensammlung wurde erfolgreich entfernt");
					});
				});

				$("#import").on("click", "#DsImportieren", function(e) {
					e.preventDefault();
					$.when(importiereDatensammlung()).then(function() {
						//jetzt Ergebnisse anzeigen
						console.log("Import ist fertig");
					});
				});

				$("#menu_btn").on("click", "#exportieren", function() {
					zeigeFormular("export");
					//Exportieren-Guids schaffen, damit kein altes existiert
					window.exportieren_guids = [];
					delete window.exportieren_objekte;
					//Exportsicherung entfernen
					delete window.exportieren_objekte_sik;
				});

				$("#export").on("change", ".exportieren_objekte_waehlen_gruppe", function() {
					erstelleListeFuerFeldwahl();
					//Tabelle ausblenden, falls sie eingeblendet war
					$("#exportieren_exportieren_tabelle").css("display", "none");
				});

				$("#export").on("change", ".feld_waehlen", function() {
					//Tabelle ausblenden, falls sie eingeblendet war
					$("#exportieren_exportieren_tabelle").css("display", "none");
				});

				$("#export").on("click", "#exportieren_objekte_Taxonomien_zusammenfassen", function(event) {
					//verhindern, dass bootstrap ganz nach oben scrollt
					event.preventDefault();
					var hinweisNeu;
					if ($(this).hasClass("active")) {
						window.fasseTaxonomienZusammen = false;
						$(this).html("Alle Taxonomien zusammenfassen");
						hinweisNeu = "<br>Alle Taxonomien sind zusammengefasst";
					} else {
						window.fasseTaxonomienZusammen = true;
						$(this).html("Taxonomien einzeln behandeln");
						hinweisNeu = "<br>Alle Taxonomien werden einzeln dargestellt";
					}
					//Felder neu aufbauen, aber nur, wenn eine Gruppe gewählt ist
					var gruppeIstGewählt = false;
					$("#exportieren_objekte_waehlen_gruppen_collapse .exportieren_objekte_waehlen_gruppe").each(function() {
						if ($(this).prop('checked')) {
							gruppeIstGewählt = true;
						}
					});
					if (gruppeIstGewählt) {
						erstelleListeFuerFeldwahl();
					}
				});

				$("#export").on("click", "#exportieren_exportieren_tabelle_aufbauen", function(event) {
					//verhindern, dass bootstrap ganz nach oben scrollt
					event.preventDefault();
					//Tabelle und Herunterladen-Schaltfläche ausblenden
					$("#exportieren_exportieren_tabelle").css("display", "none");
					$("#exportieren_exportieren_exportieren").hide();
					//filtert und baut danach die Vorschautabelle auf
					filtereFuerExport();
				});

				$("#export").on("click", "#exportieren_exportieren_exportieren", function(event) {
					//verhindern, dass bootstrap ganz nach oben scrollt
					event.preventDefault();	
					var blob = new Blob([window.exportstring], {type: "text/plain;charset=utf-8"});
					var d = new Date();
					var month = d.getMonth()+1;
					var day = d.getDate();
					var output = d.getFullYear() + '-' + (month<10 ? '0' : '') + month + '-' + (day<10 ? '0' : '') + day;
					saveAs(blob, output + "_export.csv");
				});

				$("#export").on("click", ".accordion-heading a", function(event) {
					//verhindern, dass bootstrap ganz nach oben scrollt
					event.preventDefault();
					//$($(this).attr("href")).collapse("toggle");
				});

				$("#import").on("click", ".accordion-heading a", function(event) {
					//verhindern, dass bootstrap ganz nach oben scrollt
					event.preventDefault();
					//$($(this).attr("href")).collapse("toggle");
				});
				
				//Suche steuern bei Eingabe
				$("#menu").on("keyup click", "#suchfeld", function(e) {
					e.preventDefault();
					//nur automatisch suchen, wenn das schnell ist
					//auf Enter-Taste immer suchen
					if (/*(this.value.length > 2 && window.baum_laenge < 7000) || */e.keyCode === 13) {
						$("#tree" + window.Gruppe).jstree("search", this.value);
					} else if (this.value.length === 0) {
						//Suche beenden, falls Suchfeld leer ist
						$("#tree" + window.Gruppe).jstree("clear_search");
					}
				});

				//Suche steuern bei click auf Such-icon
				$("#menu").on("click", "#suchfeld_icon", function(e) {
					e.preventDefault();
					var suchwert = $("#suchfeld").val();
					if (suchwert) {
						$("#tree" + window.Gruppe).jstree("search", suchwert);
						$("#suchfeld").focus();
					} else {
						//Suche beenden, falls Suchfeld leer ist
						$("#tree" + window.Gruppe).jstree("clear_search");
					}
				});

				$("#menu").on("keyup", "#suchfeld", function() {
					schliesseNichtMarkierteNodes();
				});

				$("#menu").on("click", "#suche_leeren_btn", function() {
					if ($("#suchfeld").val()) {
						$("#suchfeld").val("");
						schliesseNichtMarkierteNodes();
					}
				});

				$(".form").on("keyup focus", "textarea", function() {
					FitToContent(this, document.documentElement.clientHeight);
				});

				//Klick auf Link zu Art steuern
				$(".form").on("click", ".LinkZuArtGleicherGruppe", function(event) {
					var id;
					event.preventDefault();
					id = $(this).attr("artid");
					$("#tree" + window.Gruppe).jstree("clear_search");
					$("#suchen").val("");
					jQuery("#tree" + window.Gruppe).jstree("deselect_all");
					jQuery("#tree" + window.Gruppe).jstree("close_all", -1);
					jQuery("#tree" + window.Gruppe).jstree("select_node", "#" + id);
				});
			});

			$(window).resize(function () {
				setzeTreehoehe();
				setzteHöheTextareas();
			});

			$("#import").on("click", "#anmelden_btn", function(event) {
				event.preventDefault();
				meldeUserAn();
			});

			$("#import").on("click", "#abmelden_btn", function(event) {
				event.preventDefault();
				meldeUserAb();
			});

			$("#import").on("keyup", "#Email", function(event) {
				/*allfällig noch vorhandenen Hinweis ausblenden*/
				$("#Emailhinweis").css("display", "none");
			});

			$("#import").on("keyup", "#Passwort", function(event) {
				/*allfällig noch vorhandenen Hinweis ausblenden*/
				$("#Passworthinweis").css("display", "none");
			});

			$("#import").on("keyup", "#Passwort2", function(event) {
				/*allfällig noch vorhandenen Hinweis ausblenden*/
				$("#Passworthinweis2").css("display", "none");
			});

			$("#import").on("click", "#konto_erstellen_btn", function(event) {
				event.preventDefault();
				$(".signup").css("display", "block");
				$("#anmelden_btn").hide();
				$("#abmelden_btn").hide();
				$("#konto_erstellen_btn").hide();
				$("#konto_speichern_btn").show();
				setTimeout(function() {
					$("#Email").focus();
				}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
			});

			$("#import").on("click", "#konto_speichern_btn", function(event) {
				event.preventDefault();
				if (validiereSignup()) {
					erstelleKonto();
					//Anmeldefenster zurücksetzen
					$(".signup").css("display", "none");
					$("#anmelden_btn").hide();
					$("#abmelden_btn").show();
					$("#konto_erstellen_btn").hide();
					$("#konto_speichern_btn").hide();
				}
			});

		</script>
	</body>
	<div id="Meldung"></div>
	
	<div id="meldung_kompatibilität" class="modal hide fade">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3>inkompatibler Browser</h3>
		</div>
		<div class="modal-body">
			<p>Ihr Browser unterstützt nicht alle Funktionen, die ArtenDb benutzt.<br><br>Um mit ArtenDb zu arbeiten, verwenden Sie eine aktuelle Version von z.B. <a href='http://www.google.de/chrome/'>Google Chrome</a> oder <a href='http://www.mozilla.org/de/firefox/new/'>Mozilla Firefox</a>.</p>
		</div>
	</div>

	<!-- Modal -->
	<div id="fileApiMeldung" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			<h3 id="myModalLabel">inkompatibler Browser</h3>
		</div>
		<div class="modal-body">
			<p id="fileApiMeldungText">One fine body…</p>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">schliessen</button>
		</div>
	</div>

	<div id="meldung_keine_exportdaten" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			<h3 id="myModalLabel">Keine Daten gewählt</h3>
		</div>
		<div class="modal-body">
			<p id="fileApiMeldungText">Es gibt keine Daten, die exportiert werden könnten.<br>Bitte prüfen Sie die Filterkriterien</p>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">schliessen</button>
		</div>
	</div>

	<div id="meldung_keine_eigenschaften" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			<h3 id="myModalLabel">Keine Eigenschaften gewählt</h3>
		</div>
		<div class="modal-body">
			<p id="fileApiMeldungText">Bitte wählen Sie Eigenschaften, die exportiert werden sollen</p>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">schliessen</button>
		</div>
	</div>

	<div id="meldung_keine_gruppen" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			<h3 id="myModalLabel">Keine Gruppe gewählt</h3>
		</div>
		<div class="modal-body">
			<p id="fileApiMeldungText">Bitte wählen Sie mindestens eine Gruppe, deren Daten exportiert werden sollen</p>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">schliessen</button>
		</div>
	</div>
</html>