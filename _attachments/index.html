<!doctype html>
<html lang="de">
<html>
	<head>
		<link rel="apple-touch-icon" href="style/images/aster.ico">
		<link rel="icon" href="style/images/aster.ico">
		<meta charset="utf-8">
		<script src="vendor/couchapp/jquery.js"></script>
		<script src="vendor/couchapp/bootstrap.js"></script>
		<script src="vendor/couchapp/jquery.jstree.js"></script>
		<script src="vendor/couchapp/jquery.cookie.js"></script>
		<script src="vendor/couchapp/jquery.hotkeys.js"></script>
		<script src="vendor/couchapp/jquery.couch.js"></script>
		<script src="vendor/couchapp/jquery.csv.js"></script>
		<script src="vendor/couchapp/jsuri.js"></script>
		<script src="vendor/couchapp/FileSaver.js"></script>
		<script src="vendor/couchapp/artendb.js"></script>
		<link rel="stylesheet" href="style/bootstrap.css">
		<link rel="stylesheet" href="style/artendb.css">
		<script src="vendor/couchapp/modernizr.js"></script>
		<title>ArtenDb</title>
	</head>
	<body>
		<div id="menu_btn" class="btn-group">
			<a class="btn dropdown-toggle btn-inverse" data-toggle="dropdown" href="#">
				Menu
				<span class="caret"></span>
			</a>
			<ul class="dropdown-menu">
				<li class="dropdown-submenu">
					<a tabindex="-1" href="#">Daten importieren / löschen</a>
					<ul class="dropdown-menu">
						<li><a id="eigenschaften_importieren" href="#">Eigenschaften</a></li>
						<li class="disabled"><a id="beziehungen_importieren" href="#">Beziehungen</a></li>
					</ul>
				</li>
				<li><a id="exportieren" href="#">Daten exportieren</a></li>
				<li class="dropdown-submenu">
					<a tabindex="-1" href="#">über diese Anwendung</a>
					<ul class="dropdown-menu">
						<li><a href="https://github.com/barbalex/artendb/blob/master/README.md" target="_blank">Projektbeschreibung</a></li>
						<li><a href="https://github.com/barbalex/artendb" target="_blank">Code</a></li>
						<li><a href="https://github.com/barbalex/artendb/commits/master" target="_blank">Letzte Änderungen</a></li>
						<li><a href="mailto:alex.barbalex@gmail.com">Kontakt</a></li>
					</ul>
				</li>
				<li id="GoogleBilderLink_li" class="disabled"><a id="GoogleBilderLink" href="" target="_blank">Bilder suchen</a></li>
				<li id="WikipediaLink_li" class="disabled"><a id="WikipediaLink" href="" target="_blank">in Wikipedia suchen</a></li>
			</ul>
		</div>
		<fieldset id="menu">
			<div>
				<div id="menu-div">
					<div id="Gruppe_label">Gruppe wählen:</div>
				</div>
				<div id="Gruppe" class="btn-group" data-toggle="buttons-radio">
					<button class="btn btn-inverse" name="Gruppe" id="GruppeFauna" value="Fauna" treeBeschriftung="Tiere">Fauna</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeFlora" value="Flora" treeBeschriftung="Pflanzen">Flora</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeMoose" value="Moose" treeBeschriftung="Moose">Moose</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeMacromycetes" value="Macromycetes" treeBeschriftung="Pilze">Pilze</button>
					<button class="btn btn-inverse" name="Gruppe" id="GruppeLebensräume" value="Lebensräume" treeBeschriftung="Lebensräume">Lebensräume</button>
				</div>
			</div>
			<div id="suchen" class="input-prepend">
				<span class="add-on"><i id="suchfeld_icon" class="icon-search"></i></span><input id="suchfeld" class="span2" type="search" placeholder="filtern">
				<button id="suche_leeren_btn" class="close">&times;</button>
			</div>
			<div id="treeFaunaBeschriftung" class="treeBeschriftung"></div>
			<div id="treeFloraBeschriftung" class="treeBeschriftung"></div>
			<div id="treeMooseBeschriftung" class="treeBeschriftung"></div>
			<div id="treeMacromycetesBeschriftung" class="treeBeschriftung"></div>
			<div id="treeLebensräumeBeschriftung" class="treeBeschriftung"></div>
			<div id="treeFauna" class="baum"></div>
			<div id="treeFlora" class="baum"></div>
			<div id="treeMoose" class="baum"></div>
			<div id="treeMacromycetes" class="baum"></div>
			<div id="treeLebensräume" class="baum"></div>
		</fieldset>

		<fieldset id="forms">

			<form id="art" class="form form-horizontal" action="#" method="get" autocomplete="off"></form>
			
			<form id="import" class="form form-horizontal" action="#" method="get" autocomplete="off">
				<div class="accordion" id="importieren_accordion">
					<div class="accordion-group" id="importieren_anmelden">
						<div class="accordion-heading accordion-group_gradient">
							<a id="importieren_anmelden_titel" class="accordion-toggle" data-toggle="collapse" href="#importieren_anmelden_collapse">1. Anmelden</a>
						</div>
						<div class="accordion-body collapse" id="importieren_anmelden_collapse">
							<div class="accordion-inner">
								<div class="control-group">
									<label class="control-label" for="Email">Email</label>
									<div class="controls">
										<input type="email" id="Email" placeholder="Email" required>
										<div id="Emailhinweis" class="hinweis text-error">Bitte Email erfassen</div>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="Passwort">Passwort</label>
									<div class="controls">
										<input type="password" id="Passwort" placeholder="Passwort" required>
										<div id="Passworthinweis" class="hinweis text-error">Bitte Passwort erfassen</div>
										<div class="signup">Vorsicht: Email und Passwort können später nicht mehr geändert werden!</div>
										<div class="signup">Es wird eine verschlüsselte Version des Passworts gespeichert. Das Original kennt ausser Ihnen niemand.</div>
									</div>
								</div>
								<div class="control-group signup">
									<label class="control-label" for="Passwort2">Passwort bestätigen</label>
									<div class="controls">
										<input type="password" id="Passwort2" placeholder="Passwort bestätigen" required>
										<div id="Passwort2hinweis" class="hinweis text-error">Bitte Passwort bestätigen</div>
										<div id="Passwort2hinweisFalsch" class="hinweis text-error">Die Passwörter stimmen nicht überein</div>
									</div>
								</div>
								<div class="control-group">
									<div class="controls">
										<button id="anmelden_btn" class="btn">anmelden</button>
										<button id="abmelden_btn" class="btn" style="display:none;">abmelden</button>
										<button id="konto_erstellen_btn" class="btn">neues Konto erstellen</button>
										<button id="konto_speichern_btn" class="btn" style="display:none;">neues Konto speichern</button>
									</div>
								</div>
								<div id="importieren_anmelden_fehler" class="alert alert-error">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_anmelden_fehler_text"></div>
								</div>
								<div id="importieren_anmelden_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_anmelden_hinweis_text"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_ds_beschreiben">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" href="#importieren_ds_beschreiben_collapse">
								2. Datensammlung beschreiben
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_ds_beschreiben_collapse">
							<div class="accordion-inner">
								<div class="control-group">
									<label class="control-label" for="DsWaehlen">Bestehende wählen</label>
									<select type="text" class="controls" id="DsWaehlen"></select>
								</div>
								<div class="controls">
									<button type="button" class="btn" id="DsLoeschen" style="display:none;">Gewählte Datensammlung und alle ihre Eigenschaften aus allen Arten und/oder Lebensräumen entfernen</button>
								</div>
								<hr>
								<div class="control-group">
									<label class="control-label" for="DsName">Name</label>
									<input type="text" class="controls" id="DsName">
								</div>
								<div class="control-group">
									<label class="control-label" for="DsBeschreibung">Beschreibung</label>
									<textarea class="controls" id="DsBeschreibung"></textarea>
								</div>
								<div class="control-group">
									<label class="control-label" for="DsDatenstand">Datenstand</label>
									<textarea class="controls" id="DsDatenstand"></textarea>
								</div>
								<div class="control-group">
									<label class="control-label" for="DsLink">Link</label>
									<textarea class="controls" id="DsLink"></textarea>
								</div>
								<div class="control-group">
									<label class="control-label" for="DsAnzDs" id="DsAnzDs_label"></label>
									<div id="DsAnzDs" class="feldtext controls"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_daten_uploaden">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" href="#importieren_daten_uploaden_collapse">
								3. Eigenschaften laden
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_daten_uploaden_collapse">
							<div class="accordion-inner">
								<div class="form-actions">
									<div class="fileupload fileupload-new" data-provides="fileupload">
										<div class="input-append">
											<div class="uneditable-input span3"><i class="icon-file fileupload-exists"></i> <span class="fileupload-preview"></span></div><span class="btn btn-file"><span class="fileupload-new">Datei wählen</span><span class="fileupload-exists">neue Datei wählen</span><input type="file" id="DsFile" /></span><a href="#" class="btn fileupload-exists" data-dismiss="fileupload">Datei entfernen</a>
										</div>
									</div>
								</div>
								<div id="DsTabelleEigenschaften" class="tabelle">
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_ids_identifizieren">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" href="#importieren_ids_identifizieren_collapse">
								4. ID's identifizieren
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_ids_identifizieren_collapse">
							<div class="accordion-inner">
								<div id="DsFelder_div" class="control-group"></div>
								<div class="control-group">
									<label class="control-label" for="DsId">zugehörige ID in ArtenDb</label>
									<select type="text" class="controls" id="DsId"  multiple="multiple" style="height:95px;">
										<option value="guid">GUID der ArtenDb</option>
										<option value="Fauna">ID der Info Fauna (NUESP)</option>
										<option value="Flora">ID der Info Flora (SISF-NR)</option>
										<option value="Moose">ID des Datenzentrums Moose Schweiz (TAXONNO)</option>
										<option value="Macromycetes">ID von Swissfungi (TaxonId)</option>
									</select>
								</div>
								<div id="importieren_ids_identifizieren_fehler" class="alert alert-error">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_ids_identifizieren_fehler_text"></div>
								</div>
								<div id="importieren_ids_identifizieren_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_ids_identifizieren_hinweis_text"></div>
								</div>
								<div id="importieren_ids_identifizieren_erfolg" class="alert alert-success">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="importieren_ids_identifizieren_erfolg_text"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="importieren_import_ausfuehren">
						<div class="accordion-heading accordion-group_gradient">
							<a class="accordion-toggle" data-toggle="collapse" href="#importieren_import_ausfuehren_collapse">
								5. Import ausführen
							</a>
						</div>
						<div class="accordion-body collapse" id="importieren_import_ausfuehren_collapse">
							<div class="accordion-inner">
								<button type="button" class="btn" id="DsImportieren">Datensammlung mit allen Eigenschaften importieren</button>
								<button type="button" class="btn disabled" id="DsEntfernen">Datensammlung mit allen Eigenschaften aus den in der geladenen Datei enthaltenen Arten/Lebensräumen entfernen</button>
							</div>
						</div>
					</div>

				</div>		
			</form>

			<form id="export" class="form form-horizontal" action="#" method="get" autocomplete="off">
				<div class="accordion" id="exportieren_accordion">
					<div class="accordion-group" id="exportieren_objekte_waehlen_gruppen">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_objekte_waehlen_gruppen_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_objekte_waehlen_gruppen_collapse" href="#">1. Gruppen wählen</a>
						</div>
						<div class="accordion-body collapse in" id="exportieren_objekte_waehlen_gruppen_collapse">
							<div class="accordion-inner">
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" value="fauna"><span id="exportieren_objekte_waehlen_gruppe_fauna">Fauna</span>
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" value="flora"><span id="exportieren_objekte_waehlen_gruppe_flora">Flora</span>
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" value="moose"><span id="exportieren_objekte_waehlen_gruppe_moose">Moose</span>
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" value="macromycetes"><span id="exportieren_objekte_waehlen_gruppe_macromycetes">Pilze</span>
								</label>
								<label class="checkbox">
									<input class="exportieren_objekte_waehlen_gruppe" type="checkbox" value="lr"><span id="exportieren_objekte_waehlen_gruppe_lr">Lebensräume</span>
								</label>
								<div id="exportieren_objekte_waehlen_gruppen_hinweis" class="alert alert-info">
									<button type="button" class="close" data-dismiss="alert">&times;</button>
									<div id="exportieren_objekte_waehlen_gruppen_hinweis_text"></div>
								</div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="exportieren_objekte_waehlen_eigenschaften">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_objekte_waehlen_eigenschaften_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_objekte_waehlen_eigenschaften_collapse" href="#">2. Arten / Lebensräume nach Eigenschaften filtern</a>
						</div>
						<div class="accordion-body collapse" id="exportieren_objekte_waehlen_eigenschaften_collapse">
							<div class="accordion-inner">
							</div>
						</div>
					</div>

					<div class="accordion-group" id="exportieren_felder_waehlen_taxonomie">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_felder_waehlen_taxonomie_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_felder_waehlen_taxonomie_collapse" href="#">3. Eigenschaften wählen: Aus der Taxonomie</a>
						</div>
						<div class="accordion-body collapse" id="exportieren_felder_waehlen_taxonomie_collapse">
							<div class="accordion-inner">
								<label class="checkbox">
									<input id="exportieren_felder_waehlen_objekt_id" class="exportieren_felder_waehlen_objekt_feld feld_waehlen" type="checkbox" feldname="GUID" value="_id">GUID
								</label>
								<label class="checkbox">
									<input id="exportieren_felder_waehlen_objekt_gruppe" class="exportieren_felder_waehlen_objekt_feld feld_waehlen" type="checkbox" feldname="Gruppe" value="Gruppe">Gruppe
								</label>
								<div id="exportieren_felder_waehlen_taxonomie_felderliste"></div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="exportieren_felder_waehlen_datesammlungen">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_felder_waehlen_datesammlungen_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_felder_waehlen_datesammlungen_collapse" href="#">3. Eigenschaften wählen: Aus Datensammlungen</a>
						</div>
						<div class="accordion-body collapse" id="exportieren_felder_waehlen_datesammlungen_collapse">
							<div class="accordion-inner">
								<div id="exportieren_felder_waehlen_datesammlungen_felderliste"></div>
							</div>
						</div>
					</div>

					<div class="accordion-group" id="exportieren_exportieren">
						<div class="accordion-heading accordion-group_gradient">
							<a id="exportieren_exportieren_titel" class="accordion-toggle" data-toggle="collapse" data-target="#exportieren_exportieren_collapse" href="#">4. Exportieren</a>
						</div>
						<div class="accordion-body collapse" id="exportieren_exportieren_collapse">
							<div class="accordion-inner">
								<button id="exportieren_exportieren_tabelle_aufbauen" class="btn">Export prüfen</button>
								<button id="exportieren_exportieren_exportieren" class="btn" style="display:none;">herunterladen</button>
								<div id="exportieren_exportieren_tabelle" class="tabelle" style="padding-top:7px;"></div>
							</div>
						</div>
					</div>

				</div>		
			</form>

		</fieldset>

		<script>
			$(document).ready(function () {
				$("#forms").hide();
				//prüfen, ob media queries unterstützt werden. Wenn nein, melden und Einsteigen verhindern
				if (!Modernizr.mq('(min-width: 10px)')) {
					$('#meldung_kompatibilität').modal();
					return;
				}

				//prüfen, ob history unterstützt wird. Wenn nein, melden und Einsteigen verhindern
				if (!Modernizr.history) {
					$('#meldung_kompatibilität').modal();
					return;
				}

				$("#suchen").hide();

				//falls URL übergeben wurde, das entsprechende Dokument öffnen
				//soll auch ausgelöst werden, wenn die Rücktaste oder Vortaste getätigt wird
				window.addEventListener('popstate', function(event) {
					oeffneUri();
				});

				//wenn User noch angemeldet ist, UI anpassen
				if (localStorage.Email) {
					$("#importieren_anmelden_titel").text("1. " + localStorage.Email + " ist angemeldet");
					$("#anmelden_btn").hide();
					$("#abmelden_btn").show();
					$("#konto_erstellen_btn").hide();
					$("#konto_speichern_btn").hide();
				}

				//Baum aufbauen, wenn Gruppe gewählt wird
				$("#menu").on("click", "[name='Gruppe']", function () {
					//Gruppe als globale Variable speichern, weil sie an vielen Orten benutzt wird
					window.Gruppe = this.value;
					$("#suchfeld").val("");
					$("#Gruppe_label").html("Gruppe:");
					$("#suchen").hide();
					$("#forms").hide();
					$("#suchen").val("");
					erstelleBaum();
				});

				//Menu: Links zu Google Bilder und Wikipedia nur aktiv setzen, wenn Art oder Lebensraum angezeigt wird
				$("body").on("click", "#menu_btn", function() {
					if ($("#art").html().length > 0) {
						$("#GoogleBilderLink_li").removeClass("disabled");
						$("#WikipediaLink_li").removeClass("disabled");
					} else {
						$("#GoogleBilderLink_li").addClass("disabled");
						$("#WikipediaLink_li").addClass("disabled");
					}
				});

				$("#menu_btn").on("click", "#eigenschaften_importieren", function() {
					zeigeFormular("import");
					//Ist der User noch angemeldet? Wenn ja: Anmeldung überspringen
					if (localStorage.Email) {
						$("#importieren_ds_beschreiben_collapse").collapse('show');
					} else {
						$("#importieren_anmelden_collapse").collapse('show');
					}
				});

				$('#importieren_ds_beschreiben_collapse').on('shown', function (event) {
					if (!localStorage.Email) {
						$('#importieren_ds_beschreiben_collapse').collapse('hide');
						setTimeout(function() {
							zurueckZurAnmeldung();
						}, 600);
					} else {
						$("#DsName").focus();
						//Daten holen
						$db = $.couch.db("artendb");
						$db.view('artendb/ds_von_objekten?group=true', {
							success: function (data) {
								//Daten in Objektvariable speichern > Wenn Ds ausgesählt, Angaben in die Felder kopieren
								window.ds_von_objekten = data;
								//DsNamen in Auswahlliste stellen
								var DsNamen = [""];
								for (i in data.rows) {
									DsNamen.push(data.rows[i].key[0]);
								}
								DsNamen.sort();
								var html = "";
								for (i in DsNamen) {
									html += "<option value='" + DsNamen[i] + "'>" + DsNamen[i] + "</option>";
								}
								$("#DsWaehlen").append(html);
							}
						});
					}
				});

				$('#importieren_daten_uploaden_collapse').on('shown', function (event) {
					if (!localStorage.Email) {
						$(this).collapse('hide');
						zurueckZurAnmeldung();
					} else {
						$('#DsFile').fileupload();
					}
				});

				$('#importieren_ids_identifizieren_collapse').on('shown', function (event) {
					if (!localStorage.Email) {
						$(this).collapse('hide');
						zurueckZurAnmeldung();
					} else {

					}
				});

				$('#importieren_import_ausfuehren_collapse').on('shown', function (event) {
					if (!localStorage.Email) {
						$(this).collapse('hide');
						zurueckZurAnmeldung();
					} else {

					}
				});

				$("#import").on("change", "#DsWaehlen", function() {
					var that = this;
					//zuerst alle Felder leeren
					$('#import textarea, #import input').each(function () {
						$(this).val('');
						$("#DsAnzDs").html("");
						$("#DsAnzDs_label").html("");
					});
					if (that.value) {
						for (i in window.ds_von_objekten.rows) {
							if (window.ds_von_objekten.rows[i].key[0] === that.value) {
								$("#DsName").val(that.value);
								for (x in window.ds_von_objekten.rows[i].key[1]) {
									$("#Ds" + x).val(window.ds_von_objekten.rows[i].key[1][x]);
								}
								$("#DsAnzDs").html(window.ds_von_objekten.rows[i].value);
								$("#DsAnzDs_label").html("Anzahl Datensätze");
								//dafür sorgen, dass textareas genug gross sind
								$('#import textarea').each(function () {
									$(this).trigger('focus');
								});
								$("#DsName").focus();
							}
							//löschen-Schaltfläche einblenden
							$("#DsLoeschen").css("display", "block");
						}
					} else {
						//löschen-Schaltfläche ausblenden
						$("#DsLoeschen").css("display", "none");
					}
				});

				$("#import").on("change", "#DsFile", function(e) {
					e.preventDefault();
					// Check for the various File API support
					if (window.File && window.FileReader && window.FileList && window.Blob) {
						// Great success! All the File APIs are supported
					} else {
						alert('Ihr Browser unterstützt diesen Vorgang leider nicht');
						return;
					}
					var file = e.target.files[0],
					reader = new FileReader();
					reader.onload = function (event) {
						window.Datensätze = $.csv.toObjects(event.target.result);
						erstelleTabelle(window.Datensätze, "DsTabelleEigenschaften");
					};
					reader.readAsText(file);
				});

				$("#import").on("change", "#DsFelder", function(e) {
					meldeErfolgVonIdIdentifikation();
				});

				$("#import").on("change", "#DsId", function(e) {
					meldeErfolgVonIdIdentifikation();
				});

				$("#import").on("click", "#DsLoeschen", function() {
					$.when(entferneDatensammlungAusAllenObjekten($("#DsName").val())).then(function() {
						//jetzt Ergebnisse anzeigen
						console.log("Löschen beendet");
					});
				});

				$("#import").on("click", "#DsImportieren", function() {
					$.when(importiereDatensammlung()).then(function() {
						//jetzt Ergebnisse anzeigen
						console.log("Import ist fertig");
					});
				});

				$("#menu_btn").on("click", "#exportieren", function() {
					zeigeFormular("export");
					//Exportieren-Guids schaffen, damit kein altes existiert
					window.exportieren_guids = [];
					window.exportieren_objekte = [];
					//das ist ein Array von Objekten = Datensammlungen
					//hier hinein werden alle Felder kopiert
					window.exportieren_datensammlungen_namen = [];
					window.exportieren_datensammlungen = [];
					window.exportieren_taxonomien_namen = [];
					window.exportieren_taxonomien = [];
				});

				$("#export").on("change", ".exportieren_objekte_waehlen_gruppe", function() {
					var that = this;
					//Beschäftigung melden
					$("#exportieren_objekte_waehlen_gruppen_hinweis").alert().css("display", "block");
					$("#exportieren_objekte_waehlen_gruppen_hinweis_text").html("Gruppe wird geladen...");
					//guids aller Objekte dieser Gruppe abfragen und danach array von guids bilden / vergrössern
					$db = $.couch.db("artendb");
					$db.view('artendb/' + that.value + "?include_docs=true", {
						success: function (data) {
							for (i in data.rows) {
								if (window.exportieren_guids.indexOf(data.rows[i].key[0]) === -1) {
									//guid an guid-array anfügen, wenn noch nicht enthalten
									window.exportieren_guids.push(data.rows[i].key[0]);
									//Objekt anfügen
									window.exportieren_objekte.push(data.rows[i].doc);
									//Datensammlungen anfügen
									for (x in data.rows[i].doc) {
										if (data.rows[i].doc[x].Typ && data.rows[i].doc[x].Typ === "Datensammlung") {
											if (window.exportieren_datensammlungen_namen.indexOf(x) === -1) {
												window.exportieren_datensammlungen_namen.push(x);
												//Namen der Datensammlung im Objekt ergänzen
												data.rows[i].doc[x].Name = x;
												window.exportieren_datensammlungen.push(data.rows[i].doc[x]);
											} else if (data.rows[i].doc[x].Felder) {
												//kontrollieren, ob alle Felder schon enthalten sind
												//fehlende ergänzen
												for (z in data.rows[i].doc[x].Felder) {
													if (!window.exportieren_datensammlungen[window.exportieren_datensammlungen_namen.indexOf(x)].Felder[z]) {
														window.exportieren_datensammlungen[window.exportieren_datensammlungen_namen.indexOf(x)].Felder[z] = data.rows[i].doc[x].Felder[z];
													}
												}
											}
										} else if (data.rows[i].doc[x].Typ && data.rows[i].doc[x].Typ === "Taxonomie") {
											if (window.exportieren_taxonomien_namen.indexOf(x) === -1) {
												window.exportieren_taxonomien_namen.push(x);
												//Namen der Taxonomie im Objekt ergänzen
												data.rows[i].doc[x].Name = x;
												window.exportieren_taxonomien.push(data.rows[i].doc[x]);
											} else if (data.rows[i].doc[x].Felder) {
												//kontrollieren, ob alle Felder schon enthalten sind
												//fehlende ergänzen
												for (z in data.rows[i].doc[x].Felder) {
													if (!window.exportieren_taxonomien[window.exportieren_taxonomien_namen.indexOf(x)].Felder[z]) {
														window.exportieren_taxonomien[window.exportieren_taxonomien_namen.indexOf(x)].Felder[z] = data.rows[i].doc[x].Felder[z];
													}
												}
											}
										}
									}
								}
							}
							//Ergebnis rückmelden
							$("#exportieren_objekte_waehlen_gruppen_hinweis").alert().css("display", "block");
							$("#exportieren_objekte_waehlen_gruppen_hinweis_text").html(data.rows.length + " Objekte aus der Gruppe " + $("#exportieren_objekte_waehlen_gruppe_" + that.value).html() + " geladen<br>Total " + window.exportieren_guids.length + " Objekte geladen");
							$("#exportieren_felder_waehlen_datesammlungen_felderliste").html(erstelleFelderUmDatensammlungenEigenschaftenZuWaehlen());
							//console.log("window.exportieren_datensammlungen_namen = " + window.exportieren_datensammlungen_namen);
							//console.log("window.exportieren_datensammlungen = " + JSON.stringify(window.exportieren_datensammlungen));
							$("#exportieren_felder_waehlen_taxonomie_felderliste").html(erstelleFelderUmTaxonomieEigenschaftenZuWaehlen());
							//console.log("window.exportieren_taxonomien_namen = " + window.exportieren_taxonomien_namen);
							//console.log("window.exportieren_taxonomien = " + JSON.stringify(window.exportieren_taxonomien));
						}
					});
				});

				$("#export").on("click", "#exportieren_exportieren_tabelle_aufbauen", function() {
					//Objekt mit allen Objekten kopieren und nicht gewollte Felder entfernen
					var exportobjekte = [];
					var id_ist_gewaehlt = $("#exportieren_felder_waehlen_objekt_id").prop('checked');
					var gruppe_ist_gewaehlt = $("#exportieren_felder_waehlen_objekt_gruppe").prop('checked');
					//Zuerst durch alle gewählten Felder gehen und eine Feldliste erstellen
					//später wird jedem Objekt jedes dieser Felder angefügt (mit Wert falls vorhanden)
					var feldliste = [];
					$(".exportieren_felder_waehlen_objekt_feld.feld_waehlen").each(function() {
						if ($(this).prop('checked')) {
							feldliste.push($(this).attr('feldname'));
						}
					});
					$("#exportieren_felder_waehlen_taxonomie_felderliste .feld_waehlen").each(function() {
						if ($(this).prop('checked')) {
							feldliste.push($(this).attr('Taxonomie') + ": " + $(this).attr('Feld'));
						}
					});
					$("#exportieren_felder_waehlen_datesammlungen_felderliste .feld_waehlen").each(function() {
						if ($(this).prop('checked')) {
							feldliste.push($(this).attr('Datensammlung') + ": " + $(this).attr('Feld'));
						}
					});
					//durch alle Objekte gehen
					for (i in window.exportieren_objekte) {
						var Objekt = {};
						//Alle Felder anfügen
						for (v in feldliste) {
							Objekt[feldliste[v]] = null;
						}
						//id und gruppe
						if (id_ist_gewaehlt) {
							Objekt.GUID = window.exportieren_objekte[i]._id;
						}
						if (gruppe_ist_gewaehlt) {
							Objekt.Gruppe = window.exportieren_objekte[i].Gruppe;
						}
						//durch alle Eigenschaften gehen
						for (x in window.exportieren_objekte[i]) {
							//Innerhalb der Taxonomie alle gewählten Felder ergänzen
							if (window.exportieren_objekte[i][x].Typ && window.exportieren_objekte[i][x].Typ === "Taxonomie" && window.exportieren_objekte[i][x].Felder) {
								for (z in window.exportieren_objekte[i][x].Felder) {
									if ($('[Taxonomie="' + x + '"][Feld="' + z + '"]').prop('checked')) {
										/*//sicherstellen, dass die Eigenschaft dieser Taxonomie existiert
										if (typeof Objekt[x] === "undefined") {
											Objekt[x] = {};
											Objekt[x].Typ = "Taxonomie";
											Objekt[x].Felder = {};
										}
										Objekt[x].Felder[z] = window.exportieren_objekte[i][x].Felder[z];*/
										Objekt[x + ": " + z] = window.exportieren_objekte[i][x].Felder[z];
									}
								}

							}
							//Innerhalb der Datensammlungen alle gewählten Felder ergänzen
							if (window.exportieren_objekte[i][x].Typ && window.exportieren_objekte[i][x].Typ === "Datensammlung" && window.exportieren_objekte[i][x].Felder) {
								for (z in window.exportieren_objekte[i][x].Felder) {
									if ($('[Datensammlung="' + x + '"][Feld="' + z + '"]').prop('checked')) {
										/*//sicherstellen, dass die Eigenschaft dieser Datensammlung existiert
										if (typeof Objekt[x] === "undefined") {
											Objekt[x] = {};
											Objekt[x].Typ = "Datensammlung";
											Objekt[x].Felder = {};
										}
										Objekt[x].Felder[z] = window.exportieren_objekte[i][x].Felder[z];*/
										Objekt[x + ": " + z] = window.exportieren_objekte[i][x].Felder[z];
									}
								}

							}
						}
						exportobjekte.push(Objekt);	
					}
					erstelleTabelle(exportobjekte, "exportieren_exportieren_tabelle");
					window.exportstring = erstelleExportString(exportobjekte);
					//console.log("window.exportstring = " + window.exportstring);
					$("#exportieren_exportieren_exportieren").show();
				});

				$("#export").on("click", "#exportieren_exportieren_exportieren", function() {
					var blob = new Blob([window.exportstring], {type: "text/plain;charset=utf-8"});
					var d = new Date();
					var month = d.getMonth()+1;
					var day = d.getDate();
					var output = d.getFullYear() + '-' + (month<10 ? '0' : '') + month + '-' + (day<10 ? '0' : '') + day;
					saveAs(blob, output + "_export.csv");
				});
				
				//Suche steuern bei Eingabe
				$("#menu").on("keyup click", "#suchfeld", function(e) {
					e.preventDefault();
					//nur automatisch suchen, wenn das schnell ist
					//auf Enter-Taste immer suchen
					if (/*(this.value.length > 2 && window.baum_laenge < 7000) || */e.keyCode === 13) {
						$("#tree" + window.Gruppe).jstree("search", this.value);
					} else if (this.value.length === 0) {
						//Suche beenden, falls Suchfeld leer ist
						$("#tree" + window.Gruppe).jstree("clear_search");
					}
				});

				//Suche steuern bei click auf Such-icon
				$("#menu").on("click", "#suchfeld_icon", function(e) {
					e.preventDefault();
					var suchwert = $("#suchfeld").val();
					if (suchwert) {
						$("#tree" + window.Gruppe).jstree("search", suchwert);
						$("#suchfeld").focus();
					} else {
						//Suche beenden, falls Suchfeld leer ist
						$("#tree" + window.Gruppe).jstree("clear_search");
					}
				});

				$("#menu").on("keyup", "#suchfeld", function() {
					schliesseNichtMarkierteNodes();
				});

				$("#menu").on("click", "#suche_leeren_btn", function() {
					if ($("#suchfeld").val()) {
						$("#suchfeld").val("");
						schliesseNichtMarkierteNodes();
					}
				});

				$(".form").on("keyup focus", "textarea", function() {
					FitToContent(this, document.documentElement.clientHeight);
				});

				//Klick auf Link zu Art steuern
				$(".form").on("click", ".LinkZuArtGleicherGruppe", function(event) {
					var id;
					event.preventDefault();
					id = $(this).attr("artid");
					$("#tree" + window.Gruppe).jstree("clear_search");
					$("#suchen").val("");
					jQuery("#tree" + window.Gruppe).jstree("deselect_all");
					jQuery("#tree" + window.Gruppe).jstree("close_all", -1);
					jQuery("#tree" + window.Gruppe).jstree("select_node", "#" + id);
				});
			});

			$(window).resize(function () {
				setzeTreehoehe();
				setzteHöheTextareas();
			});

			$("#import").on("click", "#anmelden_btn", function(event) {
				event.preventDefault();
				meldeUserAn();
			});

			$("#import").on("click", "#abmelden_btn", function(event) {
				event.preventDefault();
				meldeUserAb();
			});

			$("#import").on("keyup", "#Email", function(event) {
				/*allfällig noch vorhandenen Hinweis ausblenden*/
				$("#Emailhinweis").css("display", "none");
			});

			$("#import").on("keyup", "#Passwort", function(event) {
				/*allfällig noch vorhandenen Hinweis ausblenden*/
				$("#Passworthinweis").css("display", "none");
			});

			$("#import").on("keyup", "#Passwort2", function(event) {
				/*allfällig noch vorhandenen Hinweis ausblenden*/
				$("#Passworthinweis2").css("display", "none");
			});

			$("#import").on("click", "#konto_erstellen_btn", function(event) {
				event.preventDefault();
				$(".signup").css("display", "block");
				$("#anmelden_btn").hide();
				$("#abmelden_btn").hide();
				$("#konto_erstellen_btn").hide();
				$("#konto_speichern_btn").show();
				setTimeout(function() {
					$("#Email").focus();
				}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
			});

			$("#import").on("click", "#konto_speichern_btn", function(event) {
				event.preventDefault();
				if (validiereSignup()) {
					erstelleKonto();
					//Anmeldefenster zurücksetzen
					$(".signup").css("display", "none");
					$("#anmelden_btn").hide();
					$("#abmelden_btn").show();
					$("#konto_erstellen_btn").hide();
					$("#konto_speichern_btn").hide();
				}
			});

		</script>
	</body>
	<div id="Meldung"></div>
	
	<div id="meldung_kompatibilität" class="modal hide fade">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3>inkompatibler Browser</h3>
		</div>
		<div class="modal-body">
			<p>Ihr Browser unterstützt nicht alle Funktionen, die ArtenDb benutzt.<br><br>Um mit ArtenDb zu arbeiten, verwenden Sie eine aktuelle Version von z.B. <a href='http://www.google.de/chrome/'>Google Chrome</a> oder <a href='http://www.mozilla.org/de/firefox/new/'>Mozilla Firefox</a>.</p>
		</div>
	</div>
</html>